<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="建明 | Ming.J">
<meta property="og:url" content="http://qjm253.cn/index.html">
<meta property="og:site_name" content="建明 | Ming.J">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="建明 | Ming.J">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'ANPOHDJJYB',
      apiKey: '',
      indexName: 'Ming.J blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://qjm253.cn/"/>





  <title>建明 | Ming.J - 至清  至静</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0a9fa95ff997969441c084d8d73eacfb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">建明 | Ming.J</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">至清  至静</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-games">
          <a href="/game/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gamepad"></i> <br />
            
            游戏
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://qjm253.cn/2018/05/06/computer_networking_02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="建明 | Ming.J">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar-r.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="建明 | Ming.J">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/06/computer_networking_02/" itemprop="url">Chapter 2 Applicaiton Layer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-06T18:00:00+08:00">
                2018-05-06
              </time>
            

            

            
          </span>

          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/06/computer_networking_02/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/05/06/computer_networking_02/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          
             <span id="/2018/05/06/computer_networking_02/" class="leancloud_visitors" data-flag-title="Chapter 2 Applicaiton Layer">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<h2 id="Principles-of-Network-Applications"><a href="#Principles-of-Network-Applications" class="headerlink" title="Principles of Network Applications"></a>Principles of Network Applications</h2><ul>
<li><strong>只有端系统中才有应用层和传输层</strong></li>
</ul>
</blockquote>
<ul>
<li><h3 id="网络应用体系架构（Network-Application-Architectures）"><a href="#网络应用体系架构（Network-Application-Architectures）" class="headerlink" title="网络应用体系架构（Network Application Architectures）"></a>网络应用体系架构（Network Application Architectures）</h3><ul>
<li>client-server （C / S）</li>
<li>Peer-to-peer (P2P)</li>
<li><p>Hybird of C/S and P2P (混合架构)</p>
<blockquote>
<p>ps: 与网络体系架构（5层架构、OSI/ISO七层架构…）做一下区分</p>
</blockquote>
</li>
<li><h4 id="C-S"><a href="#C-S" class="headerlink" title="C/S"></a>C/S</h4><ul>
<li><h5 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h5><ul>
<li><strong>服务端要一直在线</strong>，且要 <strong>先于客户端启动</strong></li>
<li>服务端通常 <strong>要有一个固定的，长期不变的唯一地址</strong>（IP Address）</li>
<li>客户端之间并不直接进行通信，<strong>所有的客户端都直接与服务端通信</strong></li>
<li>易于管理</li>
</ul>
</li>
<li><h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>单点故障</li>
<li>接入客户端过多的时候，容易导致服务器过载（所以服务端通常采用分布式集群，且性能一般都比较强大）</li>
<li>维护、升级成本大</li>
</ul>
</li>
</ul>
</li>
<li><h4 id="P2P"><a href="#P2P" class="headerlink" title="P2P"></a>P2P</h4><ul>
<li>不需要一直在线的服务端</li>
<li>任意两个主机之间都可以直接通信</li>
<li><strong>高可扩展性</strong> （<strong><em>设备增加不会系统影响整体的性能</em></strong>），但是不易管理</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="Process-Communication（进程通信）"><a href="#Process-Communication（进程通信）" class="headerlink" title="Process Communication（进程通信）"></a>Process Communication（进程通信）</h3><blockquote>
<p><strong>同一主机的进程之间</strong> 通过 <strong>进程间通信（innerprocess communication）</strong> 进行通信，而不同主机的进程之间通过交换数据报（message）进行通信 =&gt; 发送进程将构造message并将其发送到网络当中，接收进程从网络中接收message，并解析它</p>
</blockquote>
<ul>
<li><h4 id="Client-and-Server-Processes-（客户端和服务端进程）"><a href="#Client-and-Server-Processes-（客户端和服务端进程）" class="headerlink" title="Client and Server Processes （客户端和服务端进程）"></a>Client and Server Processes （客户端和服务端进程）</h4><p><strong><em>In the context of a communication session between on pair of processes, the process that initiates the communication (that is, initially contacts the other process at the begining of the session) is labeled as the client, The process that waits to be contacted to begin the session is the server</em></strong></p>
<ul>
<li><p>通常我们将 <strong>发起通信的一端标记为客户端</strong></p>
</li>
<li><p>不只是C/S架构中有 <strong>服务端和客户端的概念，P2P架构中同样也有</strong>，不同的是在C/S架构中一个进程扮演的角色是固定的，而 <strong>P2P架构中同一个进程既可以是客户端，也可以是服务端</strong>，甚至可以同时扮演两个角色</p>
</li>
</ul>
</li>
<li><h4 id="The-Interface-Between-the-Process-and-the-Computer-Network-进程和网络之间的接口-gt-Socket"><a href="#The-Interface-Between-the-Process-and-the-Computer-Network-进程和网络之间的接口-gt-Socket" class="headerlink" title="The Interface Between the Process and the Computer Network (进程和网络之间的接口) =&gt; Socket"></a>The Interface Between the Process and the Computer Network (进程和网络之间的接口) =&gt; Socket</h4><img src="/img/computer_network/computer_network_08.png" title="进程和Socket关系图解">
<ul>
<li><p><strong>Socket作为Process和Network之间的门户</strong> ，发送和接收message都需要经过Socket。可以把Process比作一个工厂或仓库，而Socket就是工厂或长裤的大门</p>
</li>
<li><p>一个Socket只属于一个Process，而一个Process可以持有多个Socket</p>
</li>
<li><p>我们用 IP+Port 标识一个进程</p>
</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="Transport-Services-Available-to-Applications-（传输层给应用层所提供的服务）"><a href="#Transport-Services-Available-to-Applications-（传输层给应用层所提供的服务）" class="headerlink" title="Transport Services Available to Applications （传输层给应用层所提供的服务）"></a>Transport Services Available to Applications （传输层给应用层所提供的服务）</h3><blockquote>
<p>同时也可以说是理想情况下，应用层需要传输层给它提供哪些服务</p>
</blockquote>
<ul>
<li><h4 id="Reliable-Data-Transfer-数据的可靠传输"><a href="#Reliable-Data-Transfer-数据的可靠传输" class="headerlink" title="Reliable Data Transfer (数据的可靠传输)"></a>Reliable Data Transfer (数据的可靠传输)</h4>传输层需要向应用层提供进程到进程的可靠通信</li>
<li><h4 id="Throughput-（最小带宽的保障）"><a href="#Throughput-（最小带宽的保障）" class="headerlink" title="Throughput （最小带宽的保障）"></a>Throughput （最小带宽的保障）</h4>有些网络应用（比如网络电话）是对带宽比较敏感的，被称为 <strong>带宽敏感型应用（bandwidth-sensitive-applications）</strong>。这些应用对吞吐量有一定要求，要求吞吐量至少高于某个速率才能正常工作这样子。所以传输层就需要能为应用层提供保证吞吐量的服务</li>
<li><h4 id="Timing-（延迟保障）"><a href="#Timing-（延迟保障）" class="headerlink" title="Timing （延迟保障）"></a>Timing （延迟保障）</h4></li>
<li><h4 id="Security-（安全保障）"><a href="#Security-（安全保障）" class="headerlink" title="Security （安全保障）"></a>Security （安全保障）</h4></li>
</ul>
</li>
<li><h3 id="Transport-Services-Providede-by-the-Internet"><a href="#Transport-Services-Providede-by-the-Internet" class="headerlink" title="Transport Services Providede by the Internet"></a>Transport Services Providede by the Internet</h3><blockquote>
<p>互联网所提供的传输层服务</p>
</blockquote>
<ul>
<li><h4 id="TCP-Services"><a href="#TCP-Services" class="headerlink" title="TCP Services"></a>TCP Services</h4><blockquote>
<p>提供数据的可靠传输，不提供最小带宽，最短时延的保障，不提供安全保障</p>
</blockquote>
<ul>
<li>connect-oriented (面向连接)</li>
<li>reliable transport (可靠传输)</li>
<li>flow control (流量控制)</li>
<li>congestion control (拥塞控制)</li>
</ul>
</li>
<li><h4 id="UDP-services"><a href="#UDP-services" class="headerlink" title="UDP services"></a>UDP services</h4><blockquote>
<p>不提供可靠数据传输，不提供最小带宽，最短时延的保障，不提供安全保障</p>
</blockquote>
</li>
<li><h4 id="一些经典应用程序所采用的应用层协议和传输层协议"><a href="#一些经典应用程序所采用的应用层协议和传输层协议" class="headerlink" title="一些经典应用程序所采用的应用层协议和传输层协议"></a>一些经典应用程序所采用的应用层协议和传输层协议</h4><img src="/img/computer_network/computer_network_09.png" title="一些经典的应用程序所采用的应用层协议和传输层协议">
<ul>
<li>TCP: Telnet, FTP, SMTP, HTTP</li>
<li>UDP: SNMP, DNS, RTP, RIP</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="The-Web-and-HTTP"><a href="#The-Web-and-HTTP" class="headerlink" title="The Web and HTTP"></a>The Web and HTTP</h2></blockquote>
<ul>
<li><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><blockquote>
<p>HTTP——HypreText Transfer Protol（超文本传输协议）</p>
</blockquote>
<ul>
<li>HTTP是应用层协议（Application protocol）</li>
<li>HTTP采用的是C/S架构</li>
<li>基于TCP</li>
<li>HTTP是无状态的(stateless) =&gt; 不保存用户端的状态信息，所以HTTP协议也被称为无状态协议（stateless protocol）</li>
</ul>
</li>
<li><h3 id="Non-Persistent-and-Persistent-Connections"><a href="#Non-Persistent-and-Persistent-Connections" class="headerlink" title="Non-Persistent and Persistent Connections"></a>Non-Persistent and Persistent Connections</h3><ul>
<li><h4 id="RTT-Round-trip-time-往返时间"><a href="#RTT-Round-trip-time-往返时间" class="headerlink" title="RTT (Round-trip time, 往返时间)"></a>RTT (Round-trip time, 往返时间)</h4><p><strong>定义</strong>：一个很小的数据包（小到可以近乎忽略数据包的长度）从客户端到服务端往返一次所需要的时间</p>
<img src="/img/computer_network/computer_network_02.jpg" title="RTT">
</li>
<li><h4 id="一次HTTP请求的响应时间"><a href="#一次HTTP请求的响应时间" class="headerlink" title="一次HTTP请求的响应时间"></a>一次HTTP请求的响应时间</h4><img src="/img/computer_network/computer_network_10.png" title="一次HTTP请求的响应时间">
<ul>
<li>total = 2*RTT + transimit time</li>
<li>总的响应时间 = 2倍的RTT + 收到整个返回的对象所需要的时间（文件长度/带宽）</li>
</ul>
</li>
<li><h4 id="Non-Persistent-HTTP-（非坚持的HTTP）"><a href="#Non-Persistent-HTTP-（非坚持的HTTP）" class="headerlink" title="Non-Persistent HTTP （非坚持的HTTP）"></a>Non-Persistent HTTP （非坚持的HTTP）</h4><p>每建立一个TCP连接，只能传一个对象（object =&gt; HTML file, JPEG…）</p>
<ul>
<li>由于接收每个对象都要单独建立连接，所以 <strong>接收每个对象所需要的响应时间都包含至少两个RTT</strong></li>
<li><strong>服务器负担重</strong>：传送每个对象都需要服务器维护一个新的连接，而连接的建立和维护是有一定开销的</li>
</ul>
</li>
<li><h4 id="Persistent-HTTP-（坚持的HTTP）"><a href="#Persistent-HTTP-（坚持的HTTP）" class="headerlink" title="Persistent HTTP （坚持的HTTP）"></a>Persistent HTTP （坚持的HTTP）</h4>一个连接建立可以传第一个Object<ul>
<li>这个接收第一个对象的时候需要至少两个RTT，紧接着后面的每个对象都少了建立连接的RTT了。</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="HTTP-Message-Format"><a href="#HTTP-Message-Format" class="headerlink" title="HTTP Message Format"></a>HTTP Message Format</h3><ul>
<li><h4 id="HTTP-Request-Message-HTTP请求消息格式"><a href="#HTTP-Request-Message-HTTP请求消息格式" class="headerlink" title="HTTP Request Message (HTTP请求消息格式)"></a>HTTP Request Message (HTTP请求消息格式)</h4><img src="/img/computer_network/computer_network_11.png" title="HTTP请求消息的通用格式">
<ul>
<li><strong>method field</strong> (方法域)：GET, POST, HEAD, PUT, DELETE …</li>
<li><strong>URL</strong>: 请求位置</li>
<li><strong>Version</strong>：HTTP协议的版本号</li>
<li><strong>Header lines</strong>: 包含了请求头信息，请求头中包含一系列的键值对</li>
<li><strong>Entity body</strong>: 数据域，当使用GET请求的时候，这个域是为空的，当使用POST请求的时候，这个域包含了请求所携带的数据</li>
<li><strong>HTTP Request message都是用ASCII text表示的</strong></li>
<li>需要注意的是，请求中携带数据，不一定要使用POST方法， <strong>GET方法也同样可以携带数据</strong>。虽然GET请求的Entity body域是空的，但是GET方法可以在URL后面包含数据。</li>
</ul>
</li>
<li><h4 id="一个HTTP请求的简单例子"><a href="#一个HTTP请求的简单例子" class="headerlink" title="一个HTTP请求的简单例子"></a>一个HTTP请求的简单例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /somedir/page.html HTTP/1.1</span><br><span class="line">Host: www.someschool.edu</span><br><span class="line">Connection: close</span><br><span class="line">User-agent: Mozilla/4.0</span><br><span class="line">Accept-language: fr</span><br></pre></td></tr></table></figure>
<ul>
<li>其中第一行分别是请求方法，URL和HTTP版本</li>
<li>后面四行是请求头<ul>
<li>Host: 服务器主机的域名</li>
<li>Connection: close =&gt; 要求服务器在发送完所请求的数据之后，不保持连接</li>
<li>User-agent =&gt; 通常用来标识浏览器内核版本，服务端可以通过这个请求头对不同的浏览器返回不同的文件，这样就可以实现同一个URL针对不同的浏览器返回不同数据的功能</li>
<li>Accept-language =&gt; 告诉服务器前端所期望服务器返回数据的语言</li>
</ul>
</li>
</ul>
</li>
<li><h4 id="HTTP-Response-Message-（HTTP返回消息格式）"><a href="#HTTP-Response-Message-（HTTP返回消息格式）" class="headerlink" title="HTTP Response Message （HTTP返回消息格式）"></a>HTTP Response Message （HTTP返回消息格式）</h4><img src="/img/computer_network/computer_network_12.png" title="HTTP返回消息的通用格式">
<ul>
<li><strong>status line</strong><ul>
<li><strong>version</strong>: HTTP协议的版本号</li>
<li><strong>status code</strong>: 本次请求的状态码</li>
<li><strong>parase</strong>: 对状态码的简单描述</li>
</ul>
</li>
<li><strong>Header lines</strong>: 包含了返回头信息，返回头中包含一系列的键值对</li>
<li><strong>Entity body</strong>: 数据域，如果有的话包含了服务器返回的数据</li>
</ul>
</li>
<li><h4 id="HTTP-Response-Status-Code-HTTP-返回消息状态码"><a href="#HTTP-Response-Status-Code-HTTP-返回消息状态码" class="headerlink" title="HTTP Response Status Code (HTTP 返回消息状态码)"></a>HTTP Response Status Code (HTTP 返回消息状态码)</h4><blockquote>
<p><a href="http://tool.oschina.net/commons?type=5" target="_blank" rel="noopener">状态码列表</a></p>
</blockquote>
<ul>
<li>200 OK: 本次请求成功，并且所请求的object对象已经在Response消息中返回</li>
<li>301 Moved Permanently: 所请求的Object已经被移到另一个位置，在Response Message的Location 头中包含了Object的新位置，正常情况下浏览器会自动访问新地址</li>
<li>400 Bad Request: 服务器无法理解客户端的请求</li>
<li>404 Not Found: 所请求的object在服务器上不存在</li>
<li>505 HTTP Version Not Supported: 请求的HTTP协议版本不被服务端支持</li>
</ul>
</li>
<li><h4 id="一个HTTP回复消息的简单例子"><a href="#一个HTTP回复消息的简单例子" class="headerlink" title="一个HTTP回复消息的简单例子"></a>一个HTTP回复消息的简单例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Connection: close</span><br><span class="line">Date: Sat, 07 Jul 2007 12:00:15 GMT</span><br><span class="line">Server: Apache/1.3.0 (Unix)</span><br><span class="line">Last-Modified: Sun, 6 May 2007 09:23:24 GMT</span><br><span class="line">Content-Length: 6821</span><br><span class="line">Content-Type: text/html</span><br><span class="line"></span><br><span class="line">(data data data data data ....)</span><br></pre></td></tr></table></figure>
<p>上面的消息中包含：an initial status line，six header lines，the entity body</p>
<ul>
<li>第一行表示服务端HTTP协议版本号为1.1，客户端本次请求的状态码为200，状态码的描述为OK（表示客户端请求的服务器存在，并且服务器上存在客户端所请求的文件）</li>
<li><strong>Connection: close</strong> =&gt; 告知客户端，服务器发送完这个Object对象之后就会关闭连接</li>
<li><strong>Date</strong> =&gt; 表示服务器创建这个message的时间</li>
<li><strong>Server</strong> =&gt; 包含了服务器的一些信息，与User-Agent类似</li>
<li><strong>Last-Modified</strong> =&gt; 表示这个Object的最后修改时间，这个在浏览器进行缓存处理的时候极为有用</li>
<li><strong>Content-Length</strong> =&gt; 返回Object的数据长度</li>
<li><strong>Content-Type</strong> =&gt; 返回Object的类型</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="User-Server-Interaction-Cookies-用户服务器交互：Cookies"><a href="#User-Server-Interaction-Cookies-用户服务器交互：Cookies" class="headerlink" title="User-Server Interaction: Cookies (用户服务器交互：Cookies)"></a>User-Server Interaction: Cookies (用户服务器交互：Cookies)</h3><ul>
<li><h4 id="Cookies-技术四大组件"><a href="#Cookies-技术四大组件" class="headerlink" title="Cookies 技术四大组件"></a>Cookies 技术四大组件</h4><ul>
<li>A cookie header line in the HTTP response message (HTTP返回消息中的一个cookie头行：例如 <strong>Set-cookie: 1678</strong>)</li>
<li>A cookie header line in the HTTP request message（HTTP请求消息中的一个cookie头行：例如 <strong>Cookie: 1678</strong>）</li>
<li>A cookie file kept on the use’s end system and managed by use’s browser (一个cookie文件，持久化在客户终端，并且由客户端浏览器统一管理)</li>
<li>A back-end database at the Web site (网站上的后端数据库 =&gt; 服务器上记录用户的状态信息，通过请求中的cookie，从数据库中取出对应的信息).</li>
</ul>
</li>
<li><h4 id="交互示例"><a href="#交互示例" class="headerlink" title="交互示例"></a>交互示例</h4><img src="/img/computer_network/computer_network_13.png" title="用户通过Cookies与服务器交互示意图">
<ul>
<li>用户一开始向服务器发送一个正常的HTTP请求</li>
<li>服务器在返回的消息中，通过 <strong>Set-cookie</strong> 头示意客户端浏览器保存一个Cookie。客户端浏览器如果打开了Cookie支持，就会将收到的Cookie存起来，持久化到Cookie文件里面</li>
<li>之后对同一网站的请求，浏览器都会在每个请求消息中自动加入 <strong>Cookie</strong> 头，并将之前持久化保存起来的Cookie信息取出，填上去</li>
<li>服务器收到带Cookie头的请求就会去数据库查询相关信息，</li>
</ul>
</li>
<li><p>使用Cookie技术，可以 <strong>在无状态的HTTP上层创建了一个可以保持用户状态的用户会话层</strong></p>
</li>
</ul>
</li>
<li><h3 id="Web-Caching（Web缓存）"><a href="#Web-Caching（Web缓存）" class="headerlink" title="Web Caching（Web缓存）"></a>Web Caching（Web缓存）</h3><blockquote>
<p><strong>Web Caching</strong>（Web缓存）也称之为 <strong>proxy server</strong>（代理服务器）。是一个可以代替源端Web服务器响应客户端请求的这么一个网络实体</p>
<ul>
<li>WEB缓存在同一时刻既作为Client（客户端），也作为Server（服务端）</li>
</ul>
</blockquote>
<ul>
<li><h4 id="Web-Caching-的工作流程"><a href="#Web-Caching-的工作流程" class="headerlink" title="Web Caching 的工作流程"></a>Web Caching 的工作流程</h4><img src="/img/computer_network/computer_network_14.png" title="Web缓存工作示意图">
<ol>
<li>首先，客户端浏览器建立一个到Web缓存的TCP连接，并将请求发送给Web缓存</li>
<li>Web缓存收到客户端的请求之后，检查本地是否有客户端要请求的object的本地缓存，如果有就将其放入HTTP Response Message中返回给客户端，否则转第三步</li>
<li>如果Web Caching中没有客户需要的Object，Web缓存就根据客户端请求中的目标地址，向源Web服务器发起一个请求，获取到客户需要的Object</li>
<li>接着Web缓存将从源服务器中收到的Object缓存到本地，并奖客户端需要的Object放入HTTP Response Message返回给客户端</li>
</ol>
</li>
<li><h4 id="采用Web缓存的好处"><a href="#采用Web缓存的好处" class="headerlink" title="采用Web缓存的好处"></a>采用Web缓存的好处</h4><ol>
<li>WEB缓存可以大大地减少客户端请求的响应时间，特别是当客户端与源服务器的瓶颈带宽远小于客户端与WEB缓存之间的瓶颈带宽的时候。=&gt; <strong>缩短响应时间，提高响应速度</strong></li>
<li><p>Web缓存能够大大减少一个机构的接入 链路到闲特网的通信量。通过减少通信量，该机构(如一家公司或者一所大学)就不必急 于增加带宽，因此降低了费用。此外，Web缓器能从整体上大大减低因特网上的 Web 流量，从而改善了所有应用的性能。 =&gt; <strong>减少源服务器的负载，降低机构的出口带宽费用，改善整个因特网的性能</strong></p>
<img src="/img/computer_network/computer_network_15.png" title="添加本地Web缓存之后的系统">
</li>
<li><p>可以提供另一条路径去访问远程服务器（VPN）。客户端访问不到源服务器但是可以访问Web缓存，而Web缓存可以访问到源服务器，那客户端就可以通过WEB缓存的代理，间接访问源服务器</p>
</li>
</ol>
</li>
<li><h4 id="采用Web缓存可能存在的缺陷"><a href="#采用Web缓存可能存在的缺陷" class="headerlink" title="采用Web缓存可能存在的缺陷"></a>采用Web缓存可能存在的缺陷</h4><ul>
<li>信息的滞后性，客户端获取到的可能不是源端最新的版本</li>
<li>解决办法：通过 <strong>Conditional GET(有条件的GET)</strong>，当Web缓存收到客户端的请求的时候，就向源服务器发送一个有条件的GET，询问客户端请求的Object与Web缓存本地的缓存的对象相比是否有更新。如果有更新，就从源服务器下载Object，更新本地的缓存，并将最新的Object返回给客户端；如果没有更新，Web缓存就直接将本地缓存的Object返回给客户端。</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="Conditional-GET-有条件的GET"><a href="#Conditional-GET-有条件的GET" class="headerlink" title="Conditional GET (有条件的GET)"></a>Conditional GET (有条件的GET)</h3><ul>
<li><h4 id="什么是有条件的GET"><a href="#什么是有条件的GET" class="headerlink" title="什么是有条件的GET"></a>什么是有条件的GET</h4><ul>
<li>The Request message use the <strong>GET</strong> method （用GET方法请求）</li>
<li>The Request message includes an <strong>If-Modified-Since:</strong> header line （请求的时候带上If-Modified-Since头）</li>
</ul>
</li>
<li><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><ol>
<li><p>一开始Web缓存本地没有缓存，收到一个客户端的请求之后就转而去请求源服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /fruit/kiwi.gif HTTP/1.1</span><br><span class="line">Host: www.exotiquecuisine.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>接着源服务器会返回类似如下的返回消息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Sat, 7 Jul 2007 15:39:29</span><br><span class="line">Server: Apache/1.3.0 (Unix)</span><br><span class="line">Last-Modified: Wed, 4 Jul 2007 09:23:24</span><br><span class="line">Content-Type: image/gif</span><br><span class="line"></span><br><span class="line">(data data data data ...)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Web缓存收到源服务器返回的消息之后</strong>，就会将Object缓存下来，同时也 <strong>会把对应的Last-Modified头信息（Object最后修改时间）保存下来</strong>。一段时间后，比如过了一周，又有一个客户端向Web缓存请求这个Object，由于过了一段时间了，这个Object可能被修改/更新过了，所以 <strong>Web缓存需要向源服务器发送一个Conditional GET</strong>， 以确定是否要从源服务器更新本地的缓存。Conditional GET请求如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /fruit/kiwi.gif HTTP/1.1</span><br><span class="line">Host: www.exotiquecuisine.com</span><br><span class="line">If-Modified-Since: Wed, 4 Jul 2007 09:23:24</span><br></pre></td></tr></table></figure>
</li>
<li><p>源服务器收到一个Conditional GET之后，会检查目标Object的最后修改时间和GET请求中 <strong>If-Modified-Since:</strong>字段的时间孰大孰小，如果时间一致，表示不用更新，会返回如下信息（如果时间不一致，则正常返回要请求的Object）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 304 Not Modified</span><br><span class="line">Date: Sat, 14 Jul 2007 15:39:29</span><br><span class="line">Server: Apache/1.3.0 (Unix)</span><br><span class="line"></span><br><span class="line">(empty entity body)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Web缓存的 <strong>Conditional GET请求</strong> 如果收到 <strong>源服务器返回的304状态码</strong>，就认为本地缓存的Object是最新的，直接将其放入HTTP Response Message 当中返回给客户端</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="File-Transfer-FTP-（文件传输协议）"><a href="#File-Transfer-FTP-（文件传输协议）" class="headerlink" title="File Transfer: FTP （文件传输协议）"></a>File Transfer: FTP （文件传输协议）</h2></blockquote>
  <img src="/img/computer_network/computer_network_16.png" title="FTP协议工作示意图">
<ul>
<li><h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><ul>
<li>基于TCP</li>
<li>采用C/S架构</li>
<li>是应用层协议</li>
<li>控制流和信息流分离，<strong>控制信息的传输采用带外传输</strong>（out-of-bound）的方式</li>
</ul>
</li>
<li><h3 id="两种连接"><a href="#两种连接" class="headerlink" title="两种连接"></a>两种连接</h3><img src="/img/computer_network/computer_network_17.png" title="FTP控制连接和数据连接">
<ul>
<li>FTP协议在 <strong>21端口上传递控制信息</strong>，在 <strong>22端口上传递数据</strong>（文件）</li>
<li>初始时客户端通过向服务器的21号端口建立一条TCP连接（control connection），并且向服务端发送identifycation，username，password等信息。接着服务端向客户端建立一条TCP连接用于传输数据（data connection）。即便在同一个Session，每传递一个新的文件都需要新开一个data connection</li>
<li><strong>控制连接</strong>（control connection）始终处于连接的状态，并且是维持用户状态的（state），<strong>数据连接</strong> 在每传输完一个文件之后就关闭，同时传输多个文件会开启多个数据连接（<strong>Non-Persistent Connection</strong>）</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="Electronic-Mail-in-the-Internet-因特网中的电子邮件"><a href="#Electronic-Mail-in-the-Internet-因特网中的电子邮件" class="headerlink" title="Electronic Mail in the Internet (因特网中的电子邮件)"></a>Electronic Mail in the Internet (因特网中的电子邮件)</h2><ul>
<li>SMTP（简单邮件传输协议）=&gt; TCP</li>
<li>POP3</li>
<li>IMAP</li>
</ul>
</blockquote>
<ul>
<li><h3 id="对比SMTP和HTTP"><a href="#对比SMTP和HTTP" class="headerlink" title="对比SMTP和HTTP"></a>对比SMTP和HTTP</h3><ul>
<li><h4 id="同："><a href="#同：" class="headerlink" title="同："></a>同：</h4><ul>
<li>两种协议都是用于从一个主机向另一个主机传输文件</li>
<li>持久HTTP和SMTP都采用持久连接</li>
<li>都是应用层协议</li>
<li>都基于TCP</li>
</ul>
</li>
<li><h4 id="异："><a href="#异：" class="headerlink" title="异："></a>异：</h4><ul>
<li><strong>HTTP</strong> 是一种 <strong>拉式协议（pull protocol）</strong>，它由想接受文件的一端发起连接；而 <strong>SMTP</strong> 是一种 <strong>推式协议（push protocol）</strong>，它由想发送文件的一端发起连接</li>
<li><strong>SMTP</strong> 的message需要使用 <strong>7-bits ASCII</strong> 格式，对于不是7-bits ASCII格式的文字或者包含比特流，都需编码为 7-bits ASCII 格式之后传送。而相比之下，HTTP就没有这种限制</li>
<li>对于包含文本和图形的文档<ul>
<li>HTTP是把每个Object放到一个Response message中发送</li>
<li>而SMTP是把所有的Object放在一个报文中发送</li>
</ul>
</li>
</ul>
</li>
<li>SMTP是一种推式协议，所以不能用来从邮件服务器上获取邮件，而应该采用其它协议来获取邮件</li>
</ul>
</li>
<li><h3 id="收发邮件所用的协议"><a href="#收发邮件所用的协议" class="headerlink" title="收发邮件所用的协议"></a>收发邮件所用的协议</h3><ul>
<li><h4 id="发邮件"><a href="#发邮件" class="headerlink" title="发邮件"></a>发邮件</h4><ul>
<li><strong>SMTP</strong> (Simple Mail Transfer Protocol)</li>
</ul>
</li>
<li><h3 id="收邮件"><a href="#收邮件" class="headerlink" title="收邮件"></a>收邮件</h3><ul>
<li><strong>POP3</strong> (Post Office Protocol——Version 3) =&gt; 邮局协议，端口110<ul>
<li>“download and delete” mode</li>
<li>“download and keep” mode</li>
</ul>
</li>
<li><strong>IMAP</strong> (Internet Mail Access Protocol) =&gt; 互联网邮件访问协议</li>
<li><strong>HTTP</strong> (HyperText Transfer Protocol) =&gt; 超文本传输协议</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><ul>
<li>Domain Name System, 域名系统</li>
<li><strong>DNS 协议基于UDP</strong>，PORT 53</li>
</ul>
</blockquote>
<ul>
<li><h3 id="DNS-Servers-组成"><a href="#DNS-Servers-组成" class="headerlink" title="DNS Servers 组成"></a>DNS Servers 组成</h3><ul>
<li><strong><em>A distributed databse implemented in a hierarchy of DNS Servers</em></strong> (一个由分层的DNS服务器实现的分布式数据库)</li>
<li><strong><em>An application-layer protocol that allows hosts to query the distributed database</em></strong> (一个使得主机能够查询这个分布式数据库的应用层协议)</li>
</ul>
</li>
<li><h3 id="Services-Provided-by-DNS-DNS所提供的服务"><a href="#Services-Provided-by-DNS-DNS所提供的服务" class="headerlink" title="Services Provided by DNS (DNS所提供的服务)"></a>Services Provided by DNS (DNS所提供的服务)</h3><ul>
<li>实现域名（<strong><em>hostname</em></strong>）和IP地址的转换 =&gt; 最主要的功能</li>
<li>支持给主机设置别名（<strong><em>Host aliasing</em></strong>）=&gt; 可以给复杂难记的域名指定一个简单易记的别名，别名指向的原域名我们称之为 <strong>规范主机名</strong>(<strong><em>canonical hostname</em></strong>)。我们可以用这个别名通过DNS服务器查到其规范主机名，进而查到对应的IP</li>
<li>支持给邮件服务器设置别名 (<strong><em>Mail Server aliasing</em></strong>)</li>
<li>支持负载均衡 (<strong><em>Load distribution</em></strong>) =&gt; 对同一个域名的访问/请求，可以由多个服务器分担</li>
</ul>
</li>
<li><h3 id="DNS服务为什么不采用集中式设计（centralized-design）"><a href="#DNS服务为什么不采用集中式设计（centralized-design）" class="headerlink" title="DNS服务为什么不采用集中式设计（centralized design）"></a>DNS服务为什么不采用集中式设计（centralized design）</h3><ul>
<li>单点故障 （<strong><em>A Single point of failure</em></strong>）</li>
<li>通信容量限制（<strong><em>Traffic volume</em></strong>）=&gt; 单个服务器无法处理上亿个甚至更多的请求</li>
<li>远距离的集中式数据库（<strong><em>Distant centralized databse</em></strong>）=&gt; 单个DNS服务器无法临近所有主机，距离越远，所产生的时延也就越大</li>
<li>维护困难（<strong><em>Maintenance</em></strong>）=&gt; 单个DNS服务器将为互联网的所有主机保存数据，将会导致中央数据库非常的庞大，难于维护。</li>
</ul>
</li>
<li><h3 id="DNS-Server-是一个分布式、分层的数据库"><a href="#DNS-Server-是一个分布式、分层的数据库" class="headerlink" title="DNS Server 是一个分布式、分层的数据库"></a>DNS Server 是一个分布式、分层的数据库</h3><img src="/img/computer_network/computer_network_18.png" title="DNS Server 分层">
<ul>
<li>Root DNS Servers =&gt; 根域名服务器（全球只有13个，大部分在北美）</li>
<li>Top-level domain (TLD) =&gt; 顶级域名服务器</li>
<li>Authoritative DNS Servers =&gt; 权威域名服务器</li>
<li>Local DNS Server =&gt; 本地域名服务器（通常每个ISP会有一个本地的域名服务器）</li>
</ul>
</li>
<li><h3 id="两种查询方式"><a href="#两种查询方式" class="headerlink" title="两种查询方式"></a>两种查询方式</h3><ul>
<li><h4 id="交互式查询（Interactive-Queries）"><a href="#交互式查询（Interactive-Queries）" class="headerlink" title="交互式查询（Interactive Queries）"></a>交互式查询（Interactive Queries）</h4><img src="/img/computer_network/computer_network_19.png" title="交互式查询方式示意图"></li>
<li><h4 id="递归式查询（Recursive-Queries）"><a href="#递归式查询（Recursive-Queries）" class="headerlink" title="递归式查询（Recursive Queries）"></a>递归式查询（Recursive Queries）</h4><img src="/img/computer_network/computer_network_20.png" title="递归式查询示意图"></li>
</ul>
</li>
<li><h3 id="DNS-Caching-DNS缓存"><a href="#DNS-Caching-DNS缓存" class="headerlink" title="DNS Caching (DNS缓存)"></a>DNS Caching (DNS缓存)</h3><p>DNS服务器会对查询过的域名对应有缓存，并且该缓存会有一个存活时间，被访问的越频繁越不容易失效</p>
<ul>
<li>DNS Caching 可以减少客户端查询DNS服务器所导致的延迟</li>
<li>DNS Caching 可以降低高级域名服务器的负载</li>
</ul>
</li>
<li><h3 id="DNS-Records"><a href="#DNS-Records" class="headerlink" title="DNS Records"></a>DNS Records</h3><p>一个DNS记录是如下的四元组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 域名，值，类型，存活时间（Time-to-live）</span></span><br><span class="line">(Name, Value, Type, TTL)</span><br></pre></td></tr></table></figure>
<ul>
<li><h4 id="记录的类型"><a href="#记录的类型" class="headerlink" title="记录的类型"></a>记录的类型</h4><ul>
<li><p><strong>A记录</strong>：Name -&gt; hostname, Value -&gt; IP</p>
<p>例：(relay1.bar.foo.com, 145.37.93.126, A)</p>
</li>
<li><p><strong>NS记录</strong>：Name -&gt; ，则 Name 是个域 (如foo. com) ，而 Value 是个知道如何获得该域中主机IP地址的权威DNS服务器的主机名</p>
<p>例：(foo.com, dns.foo.com, NS)</p>
</li>
<li><p><strong>CNAME记录</strong>：则 Value 是别名为 Name 的主机对应的规范主机名</p>
<p>例：（foo.com, relat1.var.foo.com, CNAME）</p>
</li>
<li><p><strong>MX记录</strong>：，则 Value 是个别名为 Name 的邮件服务器的规范主机名</p>
<p>例：（foo.com, mail.bar.foo.com, MX）</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="Peer-to-peer-Applicaions（P2P应用程序）"><a href="#Peer-to-peer-Applicaions（P2P应用程序）" class="headerlink" title="Peer-to-peer Applicaions（P2P应用程序）"></a>Peer-to-peer Applicaions（P2P应用程序）</h2><ul>
<li>共享资源</li>
<li>节点间课直接通信</li>
<li>非集中式</li>
</ul>
</blockquote>
<ul>
<li><h3 id="C-S-架构中存在的问题"><a href="#C-S-架构中存在的问题" class="headerlink" title="C/S 架构中存在的问题"></a>C/S 架构中存在的问题</h3><ul>
<li>难于扩展（由于服务端负载有限额，当客户端达到一定额度之后，就很难在扩展了）</li>
<li>单点故障</li>
<li>需要超级节点作为管理者（服务器的性能要足够好）</li>
<li>网络边缘的资源未得到充分的利用</li>
</ul>
</li>
<li><h3 id="P2P-的特点"><a href="#P2P-的特点" class="headerlink" title="P2P 的特点"></a>P2P 的特点</h3><ul>
<li>资源利用率高</li>
<li>可扩展性好</li>
<li>可靠性/健壮性好（无单点故障，文件有多份拷贝）</li>
<li>不需要超级节点管理，节点自管理</li>
<li>隐私不可控（BT）</li>
<li>动态性更强</li>
<li>搭便车问题</li>
</ul>
</li>
<li><h3 id="Robustness（健壮性）"><a href="#Robustness（健壮性）" class="headerlink" title="Robustness（健壮性）"></a>Robustness（健壮性）</h3>系统受到干扰之后迅速恢复回原来状态的能力。</li>
<li><h3 id="Flooding（洪泛）"><a href="#Flooding（洪泛）" class="headerlink" title="Flooding（洪泛）"></a>Flooding（洪泛）</h3>每次受到邻居节点消息之后都无条件的转发给其它邻居，导致洪泛发生。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://qjm253.cn/2018/05/05/computer_networking_01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="建明 | Ming.J">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar-r.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="建明 | Ming.J">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/05/computer_networking_01/" itemprop="url">Chapter 1 Computer Network and the Internet</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-05T18:00:00+08:00">
                2018-05-05
              </time>
            

            

            
          </span>

          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/05/computer_networking_01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/05/05/computer_networking_01/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          
             <span id="/2018/05/05/computer_networking_01/" class="leancloud_visitors" data-flag-title="Chapter 1 Computer Network and the Internet">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<h2 id="What-is-the-Internet"><a href="#What-is-the-Internet" class="headerlink" title="What is the Internet?"></a>What is the Internet?</h2><ul>
<li>There are couple of ways to answer this question. First, we can describe the nuts and bolts of the Internet, that is, the basic hardware and software components that make up the Internet. Second, we can describe the Internet in terms of a networking infrastructure that provides services to distributed applications</li>
<li>对于什么是因特网，可以从两方面来描述。首先，我们可以描述它的基本原理，即 <strong>构成Internet的基本硬件和软件组件</strong> 。其次，我们可以将其描述为 <strong>一个网络基础设施，它为分布式应用程序提供服务</strong></li>
</ul>
</blockquote>
<ul>
<li><h3 id="A-Nuts-and-Bolts-description"><a href="#A-Nuts-and-Bolts-description" class="headerlink" title="A Nuts-and-Bolts description"></a>A Nuts-and-Bolts description</h3><blockquote>
<p>数以百万计的计算机设备——<strong>主机/终端（host/end systems）</strong> 通过 <strong>通信链路（communication links）</strong> 和 <strong>分组交换机（packet switches）</strong> 相互连接在一起。</p>
</blockquote>
<ul>
<li><h4 id="主机-终端（host-end-systems）"><a href="#主机-终端（host-end-systems）" class="headerlink" title="主机/终端（host/end systems）"></a>主机/终端（host/end systems）</h4>广义所指，除了传统的PC、Linux工作站等还包括手机、TV等一众可以连接到互联网的设备</li>
<li><h4 id="通信链路（communication-links）"><a href="#通信链路（communication-links）" class="headerlink" title="通信链路（communication links）"></a>通信链路（communication links）</h4><p>通信链路有多种类型，它们基于不同的物理介质，如：同轴电缆（coaxial cable），铜线（copper wire），光纤（fiber optics）等，采用不同的材质，会影响链路的 <strong>传输速率（transmission rate）</strong></p>
<ul>
<li>传输速率（transmission rate）<ul>
<li>transmission rate = bandwidth（传输速率=带宽）==&gt; <strong>发送端发包的速率</strong></li>
<li>ps: 吞吐量 ==&gt; <strong>接收端收包的速率</strong></li>
</ul>
</li>
</ul>
</li>
<li><h4 id="分组交换机（packet-switches）"><a href="#分组交换机（packet-switches）" class="headerlink" title="分组交换机（packet switches）"></a>分组交换机（packet switches）</h4><p>A packet switch takes a packet arriving on one of its incoming communication links and forwards the packet on one of its outgoing communication links. (分组交换机的功能就是接收一个链路上发来的数据包，并将其转发给它的另一个出口链路上)目前Internet上的分组交换机主要有两种：<strong>路由器（routers）</strong> 和 <strong>链路层交换机（link-layer switches）</strong></p>
<ul>
<li>路由器（routers） ==&gt; 常在网络核心（network core）中使用</li>
<li>链路层交换机（link-layer switches） ==&gt; 常在接入网（access network）中使用</li>
</ul>
</li>
<li><h4 id="路由（route-path）"><a href="#路由（route-path）" class="headerlink" title="路由（route / path）"></a>路由（route / path）</h4>The sequence of communication links and packet switches traversed by a oacket from the sending end system and to the receiving end system is know as <strong>route</strong> or <strong>path</strong> (数据包从发送端到接收端所途经的通信链路和分组交换机组成所谓的路由) ==&gt; <strong>一个路由其实就是网络上的一条路径</strong>，某些数据包通过这条路径从发送端传输到接收端</li>
<li><h4 id="互联网服务提供商（Internet-Serveice-Providers，ISPs）"><a href="#互联网服务提供商（Internet-Serveice-Providers，ISPs）" class="headerlink" title="互联网服务提供商（Internet Serveice Providers，ISPs）"></a>互联网服务提供商（Internet Serveice Providers，ISPs）</h4>互联网服务提供商，即向广大用户综合提供互联网接入业务、信息业务、和增值业务的电信运营商</li>
</ul>
</li>
<li><h3 id="A-Sercices-description"><a href="#A-Sercices-description" class="headerlink" title="A Sercices description"></a>A Sercices description</h3><blockquote>
<p>The Internet is an infrastructure for providing services to distributed applications ==&gt; <strong>Internet一个为分布式应用提供服务的网络基础设置</strong></p>
</blockquote>
<p>对于一个分布式的网络应用程序，程序之间要进行通信就需要一个传输媒介，而Internet就很好的扮演了这个角色。</p>
</li>
</ul>
<ul>
<li><h3 id="What-is-Protocol"><a href="#What-is-Protocol" class="headerlink" title="What is Protocol?"></a>What is Protocol?</h3><p>A <strong>protocol</strong> defines the format and the order of messages exchanged between two or more communicating entities, as well as the actions taken on the transmission and/or receipt of a message or other event.</p>
<p>一个协议定义了两个通信实体之间交换信息的格式和顺序，以及在消息和其它事件的发送或接收时所采取的响应动作</p>
</li>
<li><h3 id="The-topology-structure-拓扑结构"><a href="#The-topology-structure-拓扑结构" class="headerlink" title="The topology structure (拓扑结构)"></a>The topology structure (拓扑结构)</h3><ul>
<li><h4 id="集中式"><a href="#集中式" class="headerlink" title="集中式"></a>集中式</h4>单点故障；结构，管理简单；中心节点价格昂贵，维护困难；<ul>
<li>Star =&gt; 星型</li>
<li>Tree =&gt; 树型</li>
</ul>
</li>
<li><h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><ul>
<li>Bus =&gt; 总线型</li>
<li>Mesh =&gt; 网状网 （适用于无线通信）</li>
<li>Ring =&gt; 环形</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="Network-structure-网络结构"><a href="#Network-structure-网络结构" class="headerlink" title="Network structure(网络结构)"></a>Network structure(网络结构)</h3><ul>
<li>Network edge    （网络边缘）</li>
<li>Access network  （接入网）</li>
<li>Physical media  （物理介质）</li>
<li>Network core    （网络核心）</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="The-Network-Edge-网络边缘"><a href="#The-Network-Edge-网络边缘" class="headerlink" title="The Network Edge (网络边缘)"></a>The Network Edge (网络边缘)</h2><ul>
<li>end systems     （终端）</li>
<li>access network  （接入网）</li>
<li>links           （链接）</li>
</ul>
</blockquote>
<ul>
<li><h3 id="Client-and-Server-Programs-C-S"><a href="#Client-and-Server-Programs-C-S" class="headerlink" title="Client and Server Programs (C / S)"></a>Client and Server Programs (C / S)</h3><ul>
<li><p>C/S</p>
<p>A <strong>client program</strong> is a program running on one end system that requests and receives a service from a <strong>server program</strong> running on another end system.</p>
<p>客户端程序运行在一个终端上，并且向运行在另一个终端上的服务端程序请求并获取服务。</p>
</li>
<li><p>P2P</p>
<p>同一个终端既可以作为客户端请求服务，也可以作为服务端程序提供服务</p>
</li>
</ul>
</li>
<li><h3 id="Access-network-（接入网）"><a href="#Access-network-（接入网）" class="headerlink" title="Access network （接入网）"></a>Access network （接入网）</h3><p>=&gt; 主机（终端）与边缘路由器相连的那段网络（Physical link）称之为接入网</p>
<p>=&gt; <strong>接入网很大程度上决定了用户的所能真正享有的带宽</strong></p>
</li>
<li><h3 id="Physical-Media-（物理媒介）"><a href="#Physical-Media-（物理媒介）" class="headerlink" title="Physical Media （物理媒介）"></a>Physical Media （物理媒介）</h3><blockquote>
<ul>
<li>传输的是Bits（一系列的比特流）；</li>
<li>guided media =&gt; 导向型（有线）</li>
<li>unduided media =&gt; 无导向型（无线）</li>
</ul>
</blockquote>
<ul>
<li>Twisted Pair(TP) =&gt; 双绞线</li>
<li>Coaxial Cable =&gt; 同轴电缆</li>
<li>Fiber Optics =&gt; 光纤（ <strong><em>low bit error rate (比特差错率低)</em></strong> ）</li>
<li>Terrestrial Radio Channels =&gt; 地面无线信道</li>
<li>Satellite Radio Channels =&gt; 卫星无线信道</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="The-Network-Core-网络核心"><a href="#The-Network-Core-网络核心" class="headerlink" title="The Network Core (网络核心)"></a>The Network Core (网络核心)</h2><p>=&gt; 分组交换机以及连接分组交换机间的链路</p>
</blockquote>
<p>电路交换网络和分组交换网络可以类比为饭馆订餐：电路交换网络就好比一个饭店，需要提前预定座位，并且饭店会在你预定之后再规定时间内一直为你保留预定的座位，你在既定时段的任何一个时间点去都是有位置的，期间有未预定的顾客进入，即便饭店有空位，也无法入座；而分组交换网络则好比不需要预定的饭店，先到先得，如果饭店满座了就需要等待。</p>
<ul>
<li><h3 id="Circuit-Switching-电路交换网络"><a href="#Circuit-Switching-电路交换网络" class="headerlink" title="Circuit Switching (电路交换网络)"></a>Circuit Switching (电路交换网络)</h3><blockquote>
<p>典型的就是电话网络</p>
</blockquote>
<ul>
<li><strong>Dedicated allocation</strong> =&gt; 固定分配，独占独享</li>
<li><strong>Resource reservation</strong> =&gt; 资源预留（不共享，不允许别的连接使用）</li>
<li><strong>Multiplexing</strong> =&gt; 多路复用(将网络资源切片)<ul>
<li>frequency-division multiplexing =&gt; <strong>频分多路复用</strong> (FDM)</li>
<li>time-division multiplexing =&gt; <strong>时分多路复用</strong> (TDM)<img src="/img/computer_network/computer_network_03.png" title="FDM和TDM图解"></li>
</ul>
</li>
<li>需要呼叫建立</li>
<li><p>时延小，无资源竞争</p>
</li>
<li><p>由于电路交换网络给每个Connection分配固定的带宽，分配的连接越多，意味着每个Conncetion所能享有的带宽就越少</p>
</li>
</ul>
</li>
<li><h3 id="Packet-Switching-分组交换网络"><a href="#Packet-Switching-分组交换网络" class="headerlink" title="Packet Switching (分组交换网络)"></a>Packet Switching (分组交换网络)</h3><blockquote>
<p>典型的，Internet网络采用的就是分组交换网络</p>
</blockquote>
<ul>
<li>Share network resources =&gt; 各个分组 <strong>共享网络资源</strong></li>
<li>each packet uses full link bandwidth =&gt; <strong>每个分组均能使用全部的链路带宽</strong></li>
<li>resources used as needed =&gt; <strong>资源按需分配</strong></li>
<li><p>resource contention =&gt; <strong>存在资源竞争</strong> =&gt; 可能会导致丢包，拥塞，延时等一系列问题</p>
</li>
<li><p>Statistical Multiplexing =&gt; <strong>统计复用</strong> （异步时分多路复用）</p>
<ul>
<li><p>传统的 <strong>TDM</strong>（时分多路复用）是给每一个终端分配一个 <strong>time-slot</strong>（时隙），对于某个具体的终端，不管这个终端有没有在进行通信，分配给它的那部分带宽都将被占用，是同步的</p>
</li>
<li><p>而 <strong>统计复用</strong>（异步时分多路复用）是把公共信道的时隙实行“ <strong>按需分配</strong> ”，即只对那些需要传送信息或正在工作的终端分配time-slot，这样就能使所有的时隙都能被充分的利用，可以使服务的终端数大于一个周期内时隙划分的个数，提高了媒质的利用率，从而起到了复用的作用。</p>
</li>
</ul>
</li>
<li><p><strong>Store-and-forward</strong> （存储转发）</p>
<p>=&gt; 以太网交换机的控制器先将输入端口到来的数据包缓存起来，先检查数据包是否正确，并过滤掉冲突包错误 （增加了网络的时延，但是使得网络有了一定的检错功能）</p>
</li>
<li>与电路交换相比<ul>
<li>Packet switching allows more users to use network( <strong>分组交换允许更多的用户使用网路</strong> )</li>
<li>Great forbursty data ( <strong>处理突发数据极为有效</strong> )</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="两种网络的应用场景"><a href="#两种网络的应用场景" class="headerlink" title="两种网络的应用场景"></a>两种网络的应用场景</h3><ul>
<li>在 <strong>带宽需求相对固定</strong> 的情况下， <strong>电路交换网络</strong> 比较合适<ul>
<li>资源需求稳定</li>
<li>固定电话的通信就是，语音要求的带宽非常固定，而且采用电路交换网络也可以保证通话的质量</li>
</ul>
</li>
<li>在 <strong>带宽需求动态变化</strong> 时，<strong>分组交换网络</strong> 比较适用<ul>
<li>典型的Internet网络的带宽需求就是动态变化的</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="Delay-loss-and-throughputin-Packet-Switched-Neworks"><a href="#Delay-loss-and-throughputin-Packet-Switched-Neworks" class="headerlink" title="Delay, loss and throughputin Packet-Switched Neworks"></a>Delay, loss and throughputin Packet-Switched Neworks</h2><p>在分组交换网络中的延迟，丢包和吞吐量</p>
</blockquote>
<ul>
<li><h3 id="Delay（延迟）"><a href="#Delay（延迟）" class="headerlink" title="Delay（延迟）"></a>Delay（延迟）</h3><img src="/img/computer_network/computer_network_01.png" title="路由器A的节点传输延迟">
<ul>
<li><p><strong>Nodal procesing delay</strong> =&gt; <strong>节点处理延迟</strong>（一般是很短的）</p>
<ul>
<li>差错检测 （check bit error）</li>
<li>决定从哪个口转发出去 (determine output link)</li>
</ul>
</li>
<li><p><strong>Queueing delay</strong> =&gt; 排队延迟（可以为0，也可以很长，取决于当前网络的状态）</p>
</li>
<li><strong>Transimission delay</strong> =&gt; 传输延迟（可以很小，也可以很长，取决于数据包的长度以及网络的带宽）<img src="/img/computer_network/computer_network_02.png" title="传输延迟计算方法">
=&gt; 所以 <strong>提高网络带宽只能降低传输延迟</strong></li>
<li><strong>Propagation delay</strong> =&gt; 传播延迟 （延迟的大小由物理介质的长度决定，因为传播的速度很快，所以一般这个延迟也不会很大）<img src="/img/computer_network/computer_network_04.png" title="传播延迟计算方法">
<ul>
<li>其中传播的具体速度的大小取决于是用那种物理介质传输的（光纤，双绞线等等）</li>
<li>取值范围：2*10<sup>8</sup> m/s ~ 3*10<sup>8</sup> m/s (最快接近光速)</li>
<li><strong>与数据包的长度无关</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>!!! <strong> d<sub>nodal</sub> = d<sub>proc</sub> + d<sub>queue</sub> + d<sub>trans</sub> + d<sub>prop</sub></strong><br>(数据包在一个节点上的时延 = 节点处理延迟 + 排队延迟 + 传输延迟 + 传播延迟)</p>
</blockquote>
</li>
<li><h3 id="Loss（丢包）"><a href="#Loss（丢包）" class="headerlink" title="Loss（丢包）"></a>Loss（丢包）</h3><p>当分组交换机（链路层交换机和路由器）有限缓存溢出的时候就会发生丢包</p>
<ul>
<li>可能会由前一个节点或源端节点重传，或者压根不重传</li>
<li>在端系统的视角看来，就是一个数据包已经被发送到网络核心，当时却没有到达目的节点</li>
</ul>
</li>
<li><h3 id="Throughput（吞吐量）"><a href="#Throughput（吞吐量）" class="headerlink" title="Throughput（吞吐量）"></a>Throughput（吞吐量）</h3><blockquote>
<p><a href="https://baike.baidu.com/item/%E5%90%9E%E5%90%90%E9%87%8F/157092" target="_blank" rel="noopener">百度百科</a>： 吞吐量是指对网络、设备、端口、虚电路或其他设施，单位时间内成功地传送数据的数量（以比特、字节、分组等测量）</p>
<ul>
<li>instantaneous throughput (瞬时吞吐量)</li>
<li>average throughput (平均吞吐量)</li>
</ul>
</blockquote>
<ul>
<li>在Internet网络中端到端的<strong>吞吐量</strong> 通常和 <strong>接收端收包的速率</strong> 是一致的</li>
<li>在Internet网络中的端到端吞吐量取决于网络中的<strong>瓶颈链路（Bottleneck link）</strong><img src="/img/computer_network/computer_network_05.png" title="吞吐量受瓶颈链路的影响">
</li>
</ul>
</li>
<li><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><ul>
<li>所有网络信号在物理介质上的速度近似为光速，可以认为是一样的 =&gt; 即 <strong>网络信号在传输时并无快慢之分</strong></li>
<li>之所以在 <strong>不同的链路上有带宽差别</strong>，是因为由于协议，技术等原因导致 <strong>两个相邻的数据包之间存在不同大小的时隙</strong></li>
<li>网络中一条链路上数据的传输永远是串行的（并不会出现类似“多车道”的情况）</li>
<li>Quality of service, Qos =&gt; 服务质量</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="Protocol-Layers-and-Their-Service-Models（协议分层以及他们的服务模型）"><a href="#Protocol-Layers-and-Their-Service-Models（协议分层以及他们的服务模型）" class="headerlink" title="Protocol Layers and Their Service Models（协议分层以及他们的服务模型）"></a>Protocol Layers and Their Service Models（协议分层以及他们的服务模型）</h2><p>计算机网路的体系结构（architecture）是计算机网络各层及其协议的集合</p>
</blockquote>
  <img src="/img/computer_network/computer_network_06.png" title="两种网络协议分层模型">
<ul>
<li><h3 id="PDU-Protocol-Data-Unit-网络协议数据单元"><a href="#PDU-Protocol-Data-Unit-网络协议数据单元" class="headerlink" title="PDU (Protocol Data Unit, 网络协议数据单元)"></a>PDU (Protocol Data Unit, 网络协议数据单元)</h3>同一层的所有协议所处理的数据单元</li>
<li><h3 id="Five-layer-Internet-protocol-stack-五层网络协议栈、TCP-IP协议栈"><a href="#Five-layer-Internet-protocol-stack-五层网络协议栈、TCP-IP协议栈" class="headerlink" title="Five-layer Internet protocol stack (五层网络协议栈、TCP/IP协议栈)"></a>Five-layer Internet protocol stack (五层网络协议栈、TCP/IP协议栈)</h3><img src="/img/computer_network/computer_network_01.jpg" title="五层网络协议栈模型">
<ul>
<li><h4 id="各层提供的功能"><a href="#各层提供的功能" class="headerlink" title="各层提供的功能"></a>各层提供的功能</h4><ul>
<li>Applicaiton（应用层）: 仅为用户提供接口</li>
<li>Transport（传输层）：实现进程到进程间的通信</li>
<li>Network（网络层）：实现主机到主机之间的通信</li>
<li>Link（数据链路层）：实现相邻节点间的数据传输</li>
<li>Physical（物理层）：在物理介质上传输比特流</li>
</ul>
</li>
<li><h4 id="各层的PDU"><a href="#各层的PDU" class="headerlink" title="各层的PDU"></a>各层的PDU</h4><ul>
<li>Applicaiton（应用层）: message（报文 / 消息）</li>
<li>Transport（传输层）：segment（报文段）</li>
<li>Network（网络层）：datagram（数据报）</li>
<li>Link（数据链路层）：frame（数据帧）</li>
<li>Physical（物理层）：bit（比特）</li>
</ul>
</li>
</ul>
</li>
<li><strong>协议</strong> 是对等实体之间的， <strong>服务</strong> 则是由下层通过向上层提供接口提供的</li>
<li><h3 id="Seven-layer-ISO-OSI-reference-model"><a href="#Seven-layer-ISO-OSI-reference-model" class="headerlink" title="Seven-layer ISO/OSI reference model"></a>Seven-layer ISO/OSI reference model</h3><img src="/img/computer_network/computer_network_07.png" title="OSI/ISO 七层网络协议栈模型">
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://qjm253.cn/2018/05/04/2018-5-4-database-double-not-exists/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="建明 | Ming.J">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar-r.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="建明 | Ming.J">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/04/2018-5-4-database-double-not-exists/" itemprop="url">SQL中实现关系代数中的除运算浅析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-04T18:00:00+08:00">
                2018-05-04
              </time>
            

            

            
          </span>

          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/04/2018-5-4-database-double-not-exists/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/05/04/2018-5-4-database-double-not-exists/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          
             <span id="/2018/05/04/2018-5-4-database-double-not-exists/" class="leancloud_visitors" data-flag-title="SQL中实现关系代数中的除运算浅析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2></blockquote>
<ul>
<li><p>先给出构造测试表的初始化代码，有兴趣的小伙伴可以跑一跑试试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> R;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> S;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> R (</span><br><span class="line">  X <span class="built_in">integer</span>,</span><br><span class="line">  Y <span class="built_in">varchar</span>(<span class="number">5</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> S (</span><br><span class="line">  Y <span class="built_in">varchar</span>(<span class="number">5</span>),</span><br><span class="line">  Z <span class="built_in">integer</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> R (X, Y) <span class="keyword">values</span> (</span><br><span class="line">  <span class="number">1</span>, <span class="string">'A'</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> R (X, Y) <span class="keyword">values</span> (</span><br><span class="line">  <span class="number">2</span>, <span class="string">'B'</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> R (X, Y) <span class="keyword">values</span> (</span><br><span class="line">  <span class="number">3</span>, <span class="string">'C'</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> R (X, Y) <span class="keyword">values</span> (</span><br><span class="line">  <span class="number">1</span>, <span class="string">'B'</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> R (X, Y) <span class="keyword">values</span> (</span><br><span class="line">  <span class="number">1</span>, <span class="string">'C'</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> R (X, Y) <span class="keyword">values</span> (</span><br><span class="line">  <span class="number">2</span>, <span class="string">'A'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> S (Y, Z) <span class="keyword">values</span> (</span><br><span class="line">  <span class="string">'A'</span>, <span class="number">3</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> S (Y, Z) <span class="keyword">values</span> (</span><br><span class="line">  <span class="string">'B'</span>, <span class="number">3</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> S (Y, Z) <span class="keyword">values</span> (</span><br><span class="line">  <span class="string">'C'</span>, <span class="number">3</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在整体的表结构如下</p>
<ul>
<li>R<br><img src="http://qjm253.cn/img/database/database_double_exists01.png" alt="R表详情"></li>
<li>S<br><img src="http://qjm253.cn/img/database/database_double_exists02.png" alt="S表详情"></li>
</ul>
</li>
<li>解释<ul>
<li>其中X,Y,Z都可以代表一个或多个字段</li>
<li>Y为两张表中的相同字段</li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="关系代数除运算（division）扫盲"><a href="#关系代数除运算（division）扫盲" class="headerlink" title="关系代数除运算（division）扫盲"></a>关系代数除运算（division）扫盲</h2></blockquote>
<ul>
<li>R÷S<ul>
<li>对于某个R关系中的X的某个具体值x映射到Y的集合，如果它包含关系S中Y的集合，那么这个x就会出现在结果集当中</li>
<li>像上面构造的两张表R和S，R÷S的结果就是’A’了</li>
</ul>
</li>
</ul>
<p>OK，所以说了和没说差不多，我还是不懂什么是关系代数中的除运算<em>(:з」∠)</em><br>…那下面就来举一个形象一点的栗子ლ(╹◡╹ლ)</p>
<ul>
<li>这是栗子<ul>
<li>R表示学生的选课信息，其中X表示学号，Y表示课程号</li>
<li>S表示课程的信息，其中Y表示课程号，Z表示学分</li>
<li>好现在，上面的两种表就变成下面这样了<ul>
<li>R<br><img src="http://qjm253.cn/img/database/database_double_exists04.png" alt="选课信息"></li>
<li>S<br><img src="http://qjm253.cn/img/database/database_double_exists03.png" alt="课程信息"></li>
</ul>
</li>
<li>ok，现在我们要找出一部分学生的学号，他们选了所有的课</li>
<li>R÷S ==&gt; 选了所有课的学生（很显然，上面只有学号为1的学生选了所有的课）</li>
<li>结果如下：<br><img src="http://qjm253.cn/img/database/database_double_exists05.png" alt="选了所有课的学生"></li>
</ul>
</li>
</ul>
<blockquote>
<h2 id="SQL实现"><a href="#SQL实现" class="headerlink" title="SQL实现"></a>SQL实现</h2><p>网上常见的方式就是用双重not exists来实现，咋一看不是很好理解，笔者这里对其进行稍详尽点的分步分析</p>
</blockquote>
<ul>
<li><h3 id="最终代码"><a href="#最终代码" class="headerlink" title="最终代码"></a>最终代码</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> R1.X</span><br><span class="line"><span class="keyword">FROM</span> R R1</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> S</span><br><span class="line">  <span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> R R2</span><br><span class="line">    <span class="keyword">WHERE</span> R2.X = R1.X <span class="keyword">AND</span> R2.Y = S.Y</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ul>
<li><p>我们先来对里面一层的not exists进行分析</p>
<ul>
<li><p>执行下面代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> S</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> R R2</span><br><span class="line">  <span class="keyword">WHERE</span> R2.X = <span class="number">1</span> <span class="keyword">AND</span> R2.Y = S.Y</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> S</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> R R2</span><br><span class="line">  <span class="keyword">WHERE</span> R2.X = <span class="number">2</span> <span class="keyword">AND</span> R2.Y = S.Y</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>第一个执行结果为空，第二个执行结果如下<br><img src="http://qjm253.cn/img/database/database_double_exists06.png" alt="学号为2的同学没选的课"></p>
</li>
<li>分析一下可以知道，上面的SQL完成的任务是“<strong>对于某个学号的学生，求得该学生未选的课程列表</strong>”</li>
</ul>
</li>
<li><p>OK，我们加上外层的not exists</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> R1.X</span><br><span class="line"><span class="keyword">FROM</span> R R1</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">  <span class="keyword">SELECT</span> *</span><br><span class="line">  <span class="keyword">FROM</span> S</span><br><span class="line">  <span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(</span><br><span class="line">    <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> R R2</span><br><span class="line">    <span class="keyword">WHERE</span> R2.X = R1.X <span class="keyword">AND</span> R2.Y = S.Y</span><br><span class="line">  )</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ul>
<li>从上面的分析我们知道，内层的SQL求的是对于一个具体的学生，其未选课程的列表</li>
<li>那么外层加上一个not exists，整个SQL的含义就是求没有未选课程的学生，换句话说，就是求选了所有课的学生</li>
<li>当然，第一行的DISTINCT也是很有必要的，去除了重复的X，你可以试试，不加，看一下结果，会发现每一个结果都会出现S表中Y集合的大小那么多次。</li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://qjm253.cn/2018/03/30/kotlin_01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="建明 | Ming.J">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar-r.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="建明 | Ming.J">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/30/kotlin_01/" itemprop="url">Kotlin use函数的魔法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-30T00:00:00+08:00">
                2018-03-30
              </time>
            

            

            
          </span>

          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/30/kotlin_01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/03/30/kotlin_01/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          
             <span id="/2018/03/30/kotlin_01/" class="leancloud_visitors" data-flag-title="Kotlin use函数的魔法">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<h2 id="魔法预览"><a href="#魔法预览" class="headerlink" title="魔法预览"></a>魔法预览</h2></blockquote>
<ul>
<li>实现了Closeable接口的对象可调用use函数</li>
<li>use函数会自动关闭调用者（无论中间是否出现异常）</li>
<li>Kotlin的File对象和IO流操作变得行云流水</li>
</ul>
<blockquote>
<h2 id="use函数的原型"><a href="#use函数的原型" class="headerlink" title="use函数的原型"></a>use函数的原型</h2></blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Executes the given [block] function on this resource and then closes it down correctly whether an exception</span></span><br><span class="line"><span class="comment"> * is thrown or not.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> block a function to process this [Closeable] resource.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the result of [block] function invoked on this resource.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@InlineOnly</span></span><br><span class="line"><span class="meta">@RequireKotlin(<span class="meta-string">"1.2"</span>, versionKind = RequireKotlinVersionKind.COMPILER_VERSION, message = <span class="meta-string">"Requires newer compiler version to be inlined correctly."</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : Closeable?, R&gt;</span> T.<span class="title">use</span><span class="params">(block: (<span class="type">T</span>)</span></span> -&gt; R): R &#123;</span><br><span class="line">    <span class="keyword">var</span> exception: Throwable? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> block(<span class="keyword">this</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">        exception = e</span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">when</span> &#123;</span><br><span class="line">            apiVersionIsAtLeast(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>) -&gt; <span class="keyword">this</span>.closeFinally(exception)</span><br><span class="line">            <span class="keyword">this</span> == <span class="literal">null</span> -&gt; &#123;&#125;</span><br><span class="line">            exception == <span class="literal">null</span> -&gt; close()</span><br><span class="line">            <span class="keyword">else</span> -&gt;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    close()</span><br><span class="line">                &#125; <span class="keyword">catch</span> (closeException: Throwable) &#123;</span><br><span class="line">                    <span class="comment">// cause.addSuppressed(closeException) // ignored here</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看出，use函数内部实现也是通过try-catch-finally块捕捉的方式，所以不用担心会有异常抛出导致程序退出</li>
<li>close操作在finally里面执行，所以无论是正常结束还是出现异常，都能正确关闭调用者</li>
</ul>
<blockquote>
<h2 id="来一波对比"><a href="#来一波对比" class="headerlink" title="来一波对比"></a>来一波对比</h2></blockquote>
<ul>
<li><h3 id="实现读取一个文件内每一行的功能"><a href="#实现读取一个文件内每一行的功能" class="headerlink" title="实现读取一个文件内每一行的功能"></a>实现读取一个文件内每一行的功能</h3><ul>
<li><p>java实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">DataInputStream dis = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    fis = <span class="keyword">new</span> FileInputStream(<span class="string">"/home/test.txt"</span>);</span><br><span class="line">    dis = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(fis));</span><br><span class="line">    String lines = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">while</span>((lines = dis.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">        System.out.println(lines);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(dis != <span class="keyword">null</span>)</span><br><span class="line">            dis.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(fis != <span class="keyword">null</span>)</span><br><span class="line">            fis.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Kotlin实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File(<span class="string">"/home/test.txt"</span>).readLines()</span><br><span class="line">        .forEach &#123; println(it) &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>对Kotlin就是可以两行实现。</p>
</li>
<li>仔细翻阅readLines这个扩展函数的实现你会发现，它也是间接调用了use，这样就省去了捕捉异常和关闭的烦恼</li>
<li>同样的，经过包装以后你只需要关注读出来的数据本身而不需要care各种异常情况</li>
</ul>
</li>
<li><h3 id="File的一些其它有用的扩展函数"><a href="#File的一些其它有用的扩展函数" class="headerlink" title="File的一些其它有用的扩展函数"></a>File的一些其它有用的扩展函数</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将文件里的所有数据以字节数组的形式读出</span></span><br><span class="line"><span class="comment">* Tip：显然这不适用于大文件，文件过大，会导致创建一个超大数组</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">readBytes</span><span class="params">()</span></span>: ByteArray</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 与上一个函数类似，不过这个是写（如果文件存在，则覆盖）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">writeBytes</span><span class="params">(array: <span class="type">ByteArray</span>)</span></span>： <span class="built_in">Unit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将array数组中的数据添加到文件里（如果文件存在则在文件尾部添加）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">appendBytes</span><span class="params">(array: <span class="type">ByteArray</span>)</span></span>: <span class="built_in">Unit</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将文件以指定buffer大小，分块读出（适用于大文件，也是最常用的方法）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">forEachBlock</span><span class="params">(action: (<span class="type">buffer</span>: <span class="type">ByteArray</span>, bytesRead: <span class="type">Int</span>)</span></span> -&gt; <span class="built_in">Unit</span>): <span class="built_in">Unit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets the entire content of this file as a String using UTF-8 or specified [charset].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method is not recommended on huge files. It has an internal limitation of 2 GB file size.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> charset character set to use.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the entire content of this file as a String.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">readText</span><span class="params">(charset: <span class="type">Charset</span> = Charsets.UTF_8)</span></span>: String</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the content of this file as [text] encoded using UTF-8 or specified [charset].</span></span><br><span class="line"><span class="comment"> * If this file exists, it becomes overwritten.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text text to write into file.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> charset character set to use.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">writeText</span><span class="params">(text: <span class="type">String</span>, charset: <span class="type">Charset</span> = Charsets.UTF_8)</span></span>: <span class="built_in">Unit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Appends [text] to the content of this file using UTF-8 or the specified [charset].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text text to append to file.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> charset character set to use.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">appendText</span><span class="params">(text: <span class="type">String</span>, charset: <span class="type">Charset</span> = Charsets.UTF_8)</span></span>: <span class="built_in">Unit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reads this file line by line using the specified [charset] and calls [action] for each line.</span></span><br><span class="line"><span class="comment"> * Default charset is UTF-8.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You may use this function on huge files.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> charset character set to use.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action function to process file lines.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">forEachLine</span><span class="params">(charset: <span class="type">Charset</span> = Charsets.UTF_8, action: (<span class="type">line</span>: <span class="type">String</span>)</span></span> -&gt; <span class="built_in">Unit</span>): <span class="built_in">Unit</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Reads the file content as a list of lines.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Do not use this function for huge files.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> charset character set to use. By default uses UTF-8 charset.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> list of file lines.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> File.<span class="title">readLines</span><span class="params">(charset: <span class="type">Charset</span> = Charsets.UTF_8)</span></span>: List&lt;String&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calls the [block] callback giving it a sequence of all the lines in this file and closes the reader once</span></span><br><span class="line"><span class="comment"> * the processing is complete.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> charset character set to use. By default uses UTF-8 charset.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the value returned by [block].</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequireKotlin(<span class="meta-string">"1.2"</span>, versionKind = RequireKotlinVersionKind.COMPILER_VERSION, message = <span class="meta-string">"Requires newer compiler version to be inlined correctly."</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> File.<span class="title">useLines</span><span class="params">(charset: <span class="type">Charset</span> = Charsets.UTF_8, block: (<span class="type">Sequence</span>&lt;<span class="type">String</span>&gt;)</span></span> -&gt; T): T</span><br></pre></td></tr></table></figure>
<ul>
<li>上面的函数都是基于use实现的，可以放心使用，而不用担心异常的发生，并且会自动关闭IO流</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://qjm253.cn/2018/03/26/android_wifi_direct_01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="建明 | Ming.J">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar-r.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="建明 | Ming.J">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/android_wifi_direct_01/" itemprop="url">Android WI-FI Direct Kotlin 浅析（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-26T00:00:00+08:00">
                2018-03-26
              </time>
            

            

            
          </span>

          

          
            
            <!--noindex-->
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/26/android_wifi_direct_01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count hc-comment-count" data-xid="2018/03/26/android_wifi_direct_01/" itemprop="commentsCount"></span>
                </a>
              </span>
              <!--/noindex-->
            
          

          
          
             <span id="/2018/03/26/android_wifi_direct_01/" class="leancloud_visitors" data-flag-title="Android WI-FI Direct Kotlin 浅析（一）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2></blockquote>
<ul>
<li><p>百度百科：2010年10月，Wi-Fi Alliance（wi-fi联盟）发布Wi-Fi Direct白皮书，白皮书中介绍了有关于这种技术的基本信息、这种技术的特点和这种技术的功能，Wi-Fi Direct标准是指允许无线网络中的设备无需通过无线路由器即可相互连接。与蓝牙技术类似，这种标准允许无线设备以点对点形式互连，而且在传输速度与传输距离方面则比蓝牙有大幅提升</p>
</li>
<li><p>与Android开发者而言呢，Google嗅到了WI-FI直连的发展前景，整了一套WI-FI直连的API，在Android4.0+（API &gt;= 14）的设备上均能使用。这给我们进行手机之间的互联操作提供了一个新的实现思路。它可以不需要路由而让两个设备直接相连，但其传输速度可是远远超过蓝牙传输。而且它不需要热点的建立，甚至两个设备不需要在一个局域网下。想象一下，不用建立热点也可以实现像快牙，茄子一类的面对面快传的需求～》《～</p>
</li>
</ul>
<blockquote>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2></blockquote>
<ul>
<li><h3 id="定义一个广播接收器"><a href="#定义一个广播接收器" class="headerlink" title="定义一个广播接收器"></a>定义一个广播接收器</h3><blockquote>
<ul>
<li>每当当前设备与Wi-fi直连相关的状态发生改变，系统便会以广播的形式通知我们，所以让我们定义一个Receiver欢迎它</li>
<li>在下面定义的Receiver里面我们监听了4个Action，这是最常用的4个，还有其它的Action可以看官方文档，或者，来去撸一波源码</li>
</ul>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WifiDirectReceiver</span> : <span class="type">BroadcastReceiver</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写一个便捷的注册方法，动态注册的时候就不用写intentFilter了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">registerReceiver</span><span class="params">(context: <span class="type">Context</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> intentFilter = IntentFilter()</span><br><span class="line">        intentFilter.addAction(WifiP2pManager.WIFI_P2P_STATE_CHANGED_ACTION)</span><br><span class="line">        intentFilter.addAction(WifiP2pManager.WIFI_P2P_THIS_DEVICE_CHANGED_ACTION)</span><br><span class="line">        intentFilter.addAction(WifiP2pManager.WIFI_P2P_PEERS_CHANGED_ACTION)</span><br><span class="line">        intentFilter.addAction(WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION)</span><br><span class="line">        context.registerReceiver(<span class="keyword">this</span>, intentFilter)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceive</span><span class="params">(context: <span class="type">Context</span>?, intent: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (intent?.action) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *当Wifi功能打开或关闭的时候系统会发送 WIFI_P2P_STATE_CHANGED_ACTION 广播</span></span><br><span class="line"><span class="comment">         * Tip: 并不是指是否已经成功连上WI-FI</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">            WifiP2pManager.WIFI_P2P_STATE_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 当前设备的详细信息发生变化的时候，系统会发送 WIFI_P2P_THIS_DEVICE_CHANGED_ACTION 广播</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">            WifiP2pManager.WIFI_P2P_THIS_DEVICE_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 当可连接的对等节点列表发生改变的时候，系统会发送 WIFI_P2P_PEERS_CHANGED_ACTION 广播</span></span><br><span class="line"><span class="comment">         * invoke when the list of peers find, register, lost</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">            WifiP2pManager.WIFI_P2P_PEERS_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 当一个连接建立或断开的时候，系统会发送该广播</span></span><br><span class="line"><span class="comment">         * This action received when the connection setup or dis-setup</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">            WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h3 id="接下来在Activity中动态注册"><a href="#接下来在Activity中动态注册" class="headerlink" title="接下来在Activity中动态注册"></a>接下来在Activity中动态注册</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WifiDirectActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> wifiDirectReceiver = WifiDirectReceiver()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart()</span><br><span class="line">        wifiDirectReceiver.registerReceiver(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop()</span><br><span class="line">        unregisterReceiver(wifiDirectReceiver)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>没错，直接动态注册了！！！Android8.0的新特性让Android开发喵几乎一夜之间丧失在AndroidManifest中静态注册的技能（所以为了，考虑兼容，我们就直接动态注册了）</li>
</ul>
</li>
<li><h3 id="好，接下来验证一下WIFI-P2P-STATE-CHANGED-ACTION"><a href="#好，接下来验证一下WIFI-P2P-STATE-CHANGED-ACTION" class="headerlink" title="好，接下来验证一下WIFI_P2P_STATE_CHANGED_ACTION"></a>好，接下来验证一下WIFI_P2P_STATE_CHANGED_ACTION</h3><ul>
<li><p>我们在Receiver里面加点输出（实际开发还是用Log，极不推荐直接输出，这里笔者还是决定偷懒♪(^∇^*)）</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *当Wifi功能打开或关闭的时候系统会发送 WIFI_P2P_STATE_CHANGED_ACTION 广播</span></span><br><span class="line"><span class="comment"> * Tip: 并不是指是否已经成功连上WI-FI</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WifiP2pManager.WIFI_P2P_STATE_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">    <span class="comment">//get the state of current device</span></span><br><span class="line">    <span class="keyword">val</span> state = intent.getIntExtra(WifiP2pManager.EXTRA_WIFI_STATE,</span><br><span class="line">            WifiP2pManager.WIFI_P2P_STATE_DISABLED)</span><br><span class="line">    <span class="keyword">if</span> (state == WifiP2pManager.WIFI_P2P_STATE_ENABLED) &#123;</span><br><span class="line">        <span class="comment">//Wifi p2p enable</span></span><br><span class="line">        println(<span class="string">"wifi enable"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//wifi p2p disEnable</span></span><br><span class="line">        println(<span class="string">"wifi disEnable"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后跑到真机上（万能的模拟器然而并不能模拟wifi功能，只能真机实测一波啦），反复开关Wifi功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">03-26 16:26:08.744 29313-29313/com.j.ming.eupanwifidirect I/System.out: wifi <span class="built_in">enable</span></span><br><span class="line">03-26 16:26:11.098 29313-29313/com.j.ming.eupanwifidirect I/System.out: wifi disEnable</span><br><span class="line">03-26 16:32:16.376 29313-29313/com.j.ming.eupanwifidirect I/System.out: wifi <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>OK, 得到上面的输出，我们就知道确实，这个ACTION在WI-FI功能开关的时候会触发</p>
</li>
</ul>
</li>
<li><h3 id="WIFI-P2P-THIS-DEVICE-CHANGED-ACTION"><a href="#WIFI-P2P-THIS-DEVICE-CHANGED-ACTION" class="headerlink" title="WIFI_P2P_THIS_DEVICE_CHANGED_ACTION"></a>WIFI_P2P_THIS_DEVICE_CHANGED_ACTION</h3><ul>
<li>大新闻：这个ACTION携带了一团神秘数据，^``^,那就是本设备的设备信息啦～</li>
<li><p>同样的，我们加一点输出，看一下都包含哪些信息（当然，最直接的是看WifiP2pDevice这个数据）</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当前设备的详细信息发生变化的时候，系统会发送 WIFI_P2P_THIS_DEVICE_CHANGED_ACTION 广播</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WifiP2pManager.WIFI_P2P_THIS_DEVICE_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> device: WifiP2pDevice = intent.getParcelableExtra(WifiP2pManager.EXTRA_WIFI_P2P_DEVICE)</span><br><span class="line">    println(device)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>同样真机测试，来调皮的开关一下WI-FI功能（当然，一开始也会打印出设备信息，那就是在这个Receiver被注册的时候）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">03-26 16:43:29.420 30294-30294/com.j.ming.eupanwifidirect I/System.out: wifi <span class="built_in">enable</span></span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out: Device: 魅蓝 Note3</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  deviceAddress: 2e:57:31:98:45:35</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  primary <span class="built_in">type</span>: 10-0050F204-5</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  secondary <span class="built_in">type</span>: null</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  wps: 0</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  grpcapab: 0</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  devcapab: 0</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  status: 3</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  wfdInfo: WFD enabled: falseWFD DeviceInfo: 0</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  WFD CtrlPort: 0</span><br><span class="line">03-26 16:43:29.436 30294-30294/com.j.ming.eupanwifidirect I/System.out:  WFD MaxThroughput: 0</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到包括设备的名字，本设备的MAC地址，状态balabala</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="后面两种ACTION涉及到连接，我们等下讨论"><a href="#后面两种ACTION涉及到连接，我们等下讨论" class="headerlink" title="后面两种ACTION涉及到连接，我们等下讨论"></a>后面两种ACTION涉及到连接，我们等下讨论</h3></li>
</ul>
<blockquote>
<h2 id="WifiP2pManager-的异种接口"><a href="#WifiP2pManager-的异种接口" class="headerlink" title="WifiP2pManager 的异种接口"></a>WifiP2pManager 的异种接口</h2><ul>
<li>requestPeers、requestGroupInfo、discoverPeers、createGroup、removeGroup等等</li>
<li>当然可以直接用，不过为了简介，我们一边用一遍封装出一个管理类</li>
</ul>
</blockquote>
<ul>
<li><h3 id="获得WifiP2pManager对象"><a href="#获得WifiP2pManager对象" class="headerlink" title="获得WifiP2pManager对象"></a>获得WifiP2pManager对象</h3><ul>
<li><strong>下面的操作需要添加以下权限</strong><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_WIFI_STATE"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:required</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"android.permission.CHANGE_WIFI_STATE"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:required</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> WifiDirectManager&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> manager: WifiP2pManager <span class="keyword">by</span> Delegates.notNull()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> channel: WifiP2pManager.Channel <span class="keyword">by</span> Delegates.notNull()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">(context: <span class="type">Context</span>)</span></span>: WifiDirectManager&#123;</span><br><span class="line">        <span class="comment">//通过获取系统服务的方式获得Manager对象</span></span><br><span class="line">        manager = context.getSystemService(Context.WIFI_P2P_SERVICE) <span class="keyword">as</span> WifiP2pManager</span><br><span class="line">        channel = manager.initialize(context, Looper.getMainLooper())&#123;</span><br><span class="line">            <span class="comment">//初始化操作成功的回调</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>利用Kotlin 的object关键字，快速创建一个单例对象</li>
<li>channel在后续的操作中要用到，这个是manager初始化成功之后返回的渠道对象</li>
<li>上述init方法建议在Application的onCreate中调用，至少在使用前调用</li>
</ul>
</li>
<li><h3 id="discoverPeers"><a href="#discoverPeers" class="headerlink" title="discoverPeers"></a>discoverPeers</h3><ul>
<li><p>在上述的WifiDirectManager类里面添加如下方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * discover available peer list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">discoverPeers</span><span class="params">()</span></span>: WifiDirectManager &#123;</span><br><span class="line">    manager.discoverPeers(channel, <span class="keyword">object</span> : WifiP2pManager.ActionListener&#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">()</span></span> &#123;</span><br><span class="line">            println(<span class="string">"discover Peers success"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(reason: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            println(<span class="string">"discover Peers fail: <span class="variable">$reason</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * request the peer list available</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestPeers</span><span class="params">()</span></span>: WifiDirectManager &#123;</span><br><span class="line">    manager.requestPeers(channel) &#123; peers -&gt;</span><br><span class="line">        <span class="comment">//请求对等节点列表操作成功</span></span><br><span class="line">        println(peers)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Activity里面拖一个button，在点击事件里面调用这个函数</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">btnSendTestBroadcast.setOnClickListener &#123;</span><br><span class="line">    WifiDirectManager.discoverPeers()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的方法，望文生义，就是用来检索附近的可用对等节点列表，然后后面就是这个整套API最坑的一个回调了</p>
</li>
<li><strong>WifiP2pManager.ActionListener</strong> 这个回调里面的success和failure<strong>表示的是一个操作是否执行成功，而并不能反映出这个操作的结果</strong></li>
<li>所以从上面这个回调里我们只能知道，执行discoverPeers这个操作有没有成功，是无法获取到对等节点列表的</li>
<li>那怎么获取检索的结果呢，答案是:<ul>
<li>在Receiver里面直接获取（API &gt;= 18）</li>
<li>在Receiver里面调用requestPeers()获取<br>-</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="两种获取对等节点列表的方式"><a href="#两种获取对等节点列表的方式" class="headerlink" title="两种获取对等节点列表的方式"></a>两种获取对等节点列表的方式</h3><blockquote>
<p>Tip：在调用discoverPeers之后才能获取到对等节点列表</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当可连接的对等节点列表发生改变的时候，系统会发送 WIFI_P2P_PEERS_CHANGED_ACTION 广播</span></span><br><span class="line"><span class="comment"> * invoke when the list of peers find, register, lost</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WifiP2pManager.WIFI_P2P_PEERS_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">    <span class="comment">//api &gt; 18 have this extra info,</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR2) &#123;</span><br><span class="line">        <span class="keyword">val</span> wifiP2pList: WifiP2pDeviceList = intent.getParcelableExtra(WifiP2pManager.EXTRA_P2P_DEVICE_LIST)</span><br><span class="line">        println(wifiP2pList)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//if the sdk version lower than 18</span></span><br><span class="line">        <span class="comment">//get WifiP2pDeviceList by call WifiP2pManager.requestPeers to get</span></span><br><span class="line">        WifiDirectManager.requestPeers()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到，当可用对等节点列表变化时，系统会发送 WIFI_P2P_PEERS_CHANGED_ACTION 广播，我们有两种方式获取对等节点列表</li>
<li>API &gt;= 18 的时候可以直接在 intent 携带数据中获取到 WifiP2pDeviceList 对象</li>
<li>当 API 在[14, 18) 之间的时候，只能调用manager的requestPeers方法，在回调当中获取</li>
<li><strong>其实</strong>：只要都采用第二种方式，就能保持一致性了</li>
<li>具体输出结果可以自己试一试</li>
</ul>
</li>
<li><h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * connect by MAC address(hardware address)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">connect</span><span class="params">(deviceAddress: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> config = WifiP2pConfig()</span><br><span class="line">    config.deviceAddress = deviceAddress</span><br><span class="line">    config.wps.setup = WpsInfo.PBC</span><br><span class="line">    manager.connect(channel, config, <span class="keyword">object</span> : WifiP2pManager.ActionListener &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">()</span></span> &#123;</span><br><span class="line">            println(<span class="string">"connect operator success"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(reason: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            println(<span class="string">"connect operator fail: <span class="variable">$reason</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * invoke this method to connect a p2p device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">connect</span><span class="params">(device: <span class="type">WifiP2pDevice</span>)</span></span>: WifiDirectManager &#123;</span><br><span class="line">    connect(device.deviceAddress)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在前面我们已经获取到对等节点列表了，每个对等节点设备信息里面包含其mac地址，用mac地址就能连接</li>
<li>连接成功以后 系统就会发送 WIFI_P2P_CONNECTION_CHANGED_ACTION 广播了，你可在里面获取对方设备的信息以及群组的信息</li>
<li>如果两个对等节点都没有创建群组，则连接之后其中一端设备会自动成为群组，每个组员都能获取到群组的IP</li>
</ul>
</li>
<li><h3 id="WIFI-P2P-CONNECTION-CHANGED-ACTION-包含的信息"><a href="#WIFI-P2P-CONNECTION-CHANGED-ACTION-包含的信息" class="headerlink" title="WIFI_P2P_CONNECTION_CHANGED_ACTION 包含的信息"></a>WIFI_P2P_CONNECTION_CHANGED_ACTION 包含的信息</h3><ul>
<li><p>给WifiDirectManager类添加几个封装函数</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * request the group info</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">requestGroup</span><span class="params">()</span></span>: WifiDirectManager &#123;</span><br><span class="line">    manager.requestGroupInfo(channel) &#123; group -&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create a group</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">createGroup</span><span class="params">()</span></span>: WifiDirectManager &#123;</span><br><span class="line">    manager.createGroup(channel, <span class="keyword">object</span> : WifiP2pManager.ActionListener &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(reason: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            println(<span class="string">"create group fail: <span class="variable">$reason</span>"</span>)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">()</span></span> &#123;</span><br><span class="line">            println(<span class="string">"create group success"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * remove a group</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">removeGroup</span><span class="params">()</span></span>: WifiDirectManager &#123;</span><br><span class="line">    manager.removeGroup(channel, <span class="keyword">object</span> : WifiP2pManager.ActionListener &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSuccess</span><span class="params">()</span></span> &#123;</span><br><span class="line">            println(<span class="string">"remove group success"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(reason: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            println(<span class="string">"remove group success: <span class="variable">$reason</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>看看Receiver里面的代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当一个连接建立或断开的时候，系统会发送该广播</span></span><br><span class="line"><span class="comment"> * This action received when the connection setup or dis-setup</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION -&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> networkInfo = intent.getParcelableExtra&lt;NetworkInfo&gt;(WifiP2pManager.EXTRA_NETWORK_INFO)</span><br><span class="line">        <span class="keyword">val</span> wifiP2pInfo = intent.getParcelableExtra&lt;WifiP2pInfo&gt;(WifiP2pManager.EXTRA_WIFI_P2P_INFO)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR2) &#123;</span><br><span class="line">            <span class="keyword">val</span> wifiP2pGroupInfo =  intent.getParcelableExtra&lt;WifiP2pGroup&gt;(WifiP2pManager.EXTRA_WIFI_P2P_GROUP)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从上面可以看出，当收到系统发送的 WIFI_P2P_CONNECTION_CHANGED_ACTION 广播的时候，我们可以获取下面信息</p>
<ul>
<li>NetworkInfo</li>
<li>WifiP2pInfo (对端设备的信息)</li>
<li>WifiP2pGroup （两种方式获取， 和之前获取对等节点列表的操作类似）</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="应用方式"><a href="#应用方式" class="headerlink" title="应用方式"></a>应用方式</h3><ul>
<li>可以一个设备主动创建一个Group，然后其它设备检索后连接</li>
<li>一旦连接成功，这些设备就处于同一自组网下了，组员是可以直接在WifiP2pGroup里面获取到群主的ip。接下来就可以直接用Socket进行各种骚操作了</li>
<li>至于群主如何获取组员的IP，目前想到的一种方式是群主开一个Socket监听，组员连接成功通过socket向群主发送一个请求，然后群主就可以在请求的socket对象里面获取组员的IP了</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar-r.jpg"
                alt="建明 | Ming.J" />
            
              <p class="site-author-name" itemprop="name">建明 | Ming.J</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">建明 | Ming.J</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	

		<script type="text/javascript">
		_hcwp = window._hcwp || [];

		_hcwp.push({widget:"Bloggerstream", widget_id: 99614, selector:".hc-comment-count", label: "{\%COUNT%\}" });

		

		(function() {
		if("HC_LOAD_INIT" in window)return;
		HC_LOAD_INIT = true;
		var lang = (navigator.language || navigator.systemLanguage || navigator.userLanguage || "en").substr(0, 2).toLowerCase();
		var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
		hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://w.hypercomments.com/widget/hc/99614/"+lang+"/widget.js";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(hcc, s.nextSibling);
		})();
		</script>

	
















  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("eyIFq6kYslRSDIa8lqlCIThp-gzGzoHsz", "iUAeNEuxcBmYdpgAATCh4AlH");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
